// Configuration MSAL corrig√©e - Remplacez la section <script> dans votre HTML

const msalConfig = {
  auth: {
    clientId: '58deb25d-3881-4c76-863b-70e3fcb1739b',
    authority: 'https://login.microsoftonline.com/6860fe23-4c83-4fdf-99b5-f82a4b386176',
    redirectUri: 'https://zak413.github.io/test-bd/', // URL propre sans param√®tres
    navigateToLoginRequestUrl: false // Emp√™che la redirection avec param√®tres
  },
  cache: {
    cacheLocation: 'localStorage',
    storeAuthStateInCookie: false
  },
  system: {
    allowNativeBroker: false // D√©sactive le broker natif
  }
};

const graphScopes = [
  'Directory.ReadWrite.All',
  'Application.Read.All',
  'User.Read'
];

const msalInstance = new msal.PublicClientApplication(msalConfig);
let accessToken = null;

const log = (msg) => {
  document.getElementById('logOutput').textContent += `\n[${new Date().toLocaleTimeString()}] ${msg}`;
};

// Nettoyer l'URL au chargement
window.addEventListener('load', () => {
  // Supprimer les param√®tres admin_consent de l'URL
  const url = new URL(window.location);
  if (url.searchParams.has('admin_consent') || url.searchParams.has('tenant')) {
    url.searchParams.delete('admin_consent');
    url.searchParams.delete('tenant');
    url.searchParams.delete('state');
    url.searchParams.delete('session_state');
    // Rediriger vers l'URL propre
    window.history.replaceState({}, document.title, url.toString());
    log('URL nettoy√©e des param√®tres admin_consent');
  }
  log('Page charg√©e correctement');
});

document.getElementById('loginBtn').onclick = async () => {
  try {
    log('Tentative de connexion...');
    
    const loginRequest = {
      scopes: graphScopes,
      prompt: 'select_account' // Force la s√©lection du compte
    };

    const loginResponse = await msalInstance.loginPopup(loginRequest);
    
    const tokenRequest = {
      account: loginResponse.account,
      scopes: graphScopes,
      forceRefresh: false
    };

    const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
    accessToken = tokenResponse.accessToken;
    
    log(`‚úÖ Connect√© avec succ√®s : ${loginResponse.account.username}`);
    document.getElementById('assignRoleBtn').disabled = false;
    document.getElementById('loginBtn').style.display = 'none';
    
  } catch (err) {
    log('‚ùå Erreur de connexion : ' + err.message);
    console.error('D√©tails de l\'erreur:', err);
  }
};

document.getElementById('assignRoleBtn').onclick = async () => {
  const appName = document.getElementById('appName').value.trim();
  if (!accessToken || !appName) {
    log('‚ùå Token manquant ou nom d\'application vide');
    return;
  }

  const baseUrl = 'https://graph.microsoft.com/v1.0';

  const graphRequest = async (url, options = {}) => {
    const res = await fetch(url, {
      ...options,
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        ...options.headers
      }
    });
    
    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`[${res.status}] ${errorText}`);
    }
    return res.json();
  };

  try {
    document.getElementById('assignRoleBtn').disabled = true;
    document.getElementById('assignRoleBtn').textContent = '‚è≥ Attribution en cours...';
    
    log(`üîç Recherche de l'application "${appName}"...`);
    
    // Rechercher par displayName dans les service principals (applications d'entreprise)
    const spData = await graphRequest(`${baseUrl}/servicePrincipals?$filter=displayName eq '${encodeURIComponent(appName)}'`);
    
    if (!spData.value.length) {
      throw new Error(`Application "${appName}" non trouv√©e dans les applications d'entreprise.`);
    }
    
    const sp = spData.value[0];
    log(`‚úÖ Service principal trouv√© : ${sp.id}`);

    log('üîç Recherche du r√¥le User Administrator...');
    let roles = await graphRequest(`${baseUrl}/directoryRoles?$filter=displayName eq 'User Administrator'`);
    let role = roles.value[0];

    if (!role) {
      log('‚ö†Ô∏è Activation du r√¥le User Administrator...');
      role = await graphRequest(`${baseUrl}/directoryRoles`, {
        method: 'POST',
        body: JSON.stringify({ roleTemplateId: 'fe930be7-5e62-47db-91af-98c3a49a38b1' })
      });
      log('‚úÖ R√¥le activ√©');
    } else {
      log('‚úÖ R√¥le d√©j√† activ√©');
    }

    log('üîç V√©rification des membres existants...');
    const members = await graphRequest(`${baseUrl}/directoryRoles/${role.id}/members`);
    
    if (members.value.some(m => m.id === sp.id)) {
      log('‚ÑπÔ∏è L\'application est d√©j√† membre du r√¥le User Administrator.');
      document.getElementById('assignRoleBtn').textContent = '‚úÖ D√©j√† attribu√©';
      return;
    }

    log('‚ö° Attribution du r√¥le √† l\'application...');
    await fetch(`${baseUrl}/directoryRoles/${role.id}/members/$ref`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        '@odata.id': `${baseUrl}/directoryObjects/${sp.id}`
      })
    });

    log('üéâ SUCC√àS : Le r√¥le User Administrator a √©t√© attribu√© √† l\'application !');
    document.getElementById('assignRoleBtn').textContent = '‚úÖ R√¥le attribu√©';
    document.getElementById('assignRoleBtn').style.background = '#27ae60';

  } catch (err) {
    log('‚ùå Erreur : ' + err.message);
    document.getElementById('assignRoleBtn').disabled = false;
    document.getElementById('assignRoleBtn').textContent = 'R√©essayer';
    console.error('Erreur compl√®te:', err);
  }
};
